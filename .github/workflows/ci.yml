# 单元测试、构建测试、集成测试（DLC/AdGuard 规则、分流、UDP/TCP、指标、稳定性）
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  COREDNS_VER: v1.14.1
  PLUGIN_REPO: github.com/hr3lxphr6j/coredns-ruledforward

jobs:
  unit:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
          cache-dependency-path: go.sum
      - run: make test

  build:
    name: Build (CoreDNS + plugin)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
      - run: make build

  integration:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: [unit]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.26'
      - name: Download dlc.dat
        run: |
          mkdir -p integration/fixtures
          curl -fSL -o integration/fixtures/dlc.dat \
            https://github.com/v2fly/domain-list-community/releases/latest/download/dlc.dat
      - run: make integration
